<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MirrorTalk">
<meta name="theme-color" content="#0a0a1a">
<title>MirrorTalk</title>
<style>
:root{
  --bg:#0a0a1a;
  --border:rgba(255,255,255,0.13);
  --border-glow:rgba(255,255,255,0.28);
  --text:#f0f0ff;
  --muted:rgba(240,240,255,0.32);
  --blue:#4f9fff;
  --red:#ff5f7e;
  --cyan:#4ff0d0;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{
  width:100%;height:100%;overflow:hidden;
  -webkit-text-size-adjust:none;
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;
  -webkit-font-smoothing:antialiased;
}
#app{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  padding-top:var(--safe-t);
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%,rgba(79,159,255,0.13) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%,rgba(79,240,208,0.11) 0%,transparent 60%),
    var(--bg);
}

/* HEADER */
.hdr{
  flex-shrink:0;padding:10px 16px 7px;text-align:center;
  border-bottom:1px solid var(--border);
}
.hdr h1{
  font-size:22px;font-weight:800;letter-spacing:-.02em;
  background:linear-gradient(90deg,#f0f0ff,var(--cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.hdr p{font-size:11px;color:var(--muted);margin-top:1px}
.badge{
  display:inline-flex;align-items:center;gap:4px;
  margin-top:5px;padding:3px 12px;border-radius:50px;
  background:rgba(79,240,208,0.09);border:1px solid rgba(79,240,208,0.22);
  font-size:10px;font-weight:700;letter-spacing:.05em;color:var(--cyan);
}

/* MIRROR */
#mirror{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}

.half{
  flex:1;min-height:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:14px 20px 10px;gap:11px;
  position:relative;
}
.half.top{transform:rotate(180deg);border-bottom:1px solid var(--border)}
.lbl{
  position:absolute;top:6px;left:50%;transform:translateX(-50%);
  font-size:10px;font-weight:700;letter-spacing:.13em;
  color:var(--muted);text-transform:uppercase;white-space:nowrap;
}
.half.top .lbl{top:auto;bottom:6px}

/* LANGUAGE SELECT */
.lang-sel{
  flex-shrink:0;
  background:rgba(255,255,255,0.09);border:1px solid var(--border);
  border-radius:50px;color:var(--text);
  font-size:16px;font-weight:600;padding:10px 22px;
  outline:none;-webkit-appearance:none;cursor:pointer;
  width:100%;max-width:280px;text-align:center;
}
.lang-sel option{background:#1a1a30}

/* TRANSCRIPT */
.transcript{
  width:100%;max-width:340px;flex:1;
  min-height:54px;max-height:115px;
  display:flex;align-items:center;justify-content:center;
  text-align:center;padding:12px 14px;
  font-size:18px;line-height:1.5;
  border-radius:14px;border:1px solid transparent;
  overflow-y:auto;transition:background .3s,border-color .3s;
}
.transcript.ph{color:var(--muted);font-style:italic;font-size:14px}
.transcript.listening{background:rgba(79,159,255,0.09);border-color:rgba(79,159,255,0.35)}
.transcript.speaking{background:rgba(79,240,208,0.09);border-color:rgba(79,240,208,0.35)}

/* STATUS */
.st{
  font-size:13px;color:var(--cyan);
  display:flex;align-items:center;gap:6px;min-height:18px;flex-shrink:0;
}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{
  width:13px;height:13px;flex-shrink:0;
  border:2px solid rgba(79,240,208,0.25);border-top-color:var(--cyan);
  border-radius:50%;animation:spin .75s linear infinite;
}

/* MIC BUTTON */
.bwrap{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:5px}
.tmr{font-size:12px;font-weight:700;color:var(--muted);min-height:15px}

.mic{
  width:96px;height:96px;border-radius:50%;border:none;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  position:relative;
  -webkit-tap-highlight-color:transparent;
  background:transparent;
  transition:transform .12s;
  /* permittiamo il touch passare */
  touch-action:manipulation;
}
.mic:active{transform:scale(0.85)}

.inner{
  position:absolute;inset:0;border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;font-size:12px;font-weight:700;color:#fff;pointer-events:none;
}
.inner svg{width:30px;height:30px}

.mic.blue .inner{
  background:linear-gradient(135deg,#4f9fff,#2060d0);
  box-shadow:0 6px 24px rgba(79,159,255,0.55),inset 0 0 0 1px rgba(255,255,255,0.18);
}
.mic.red .inner{
  background:linear-gradient(135deg,#ff5f7e,#b02848);
  box-shadow:0 6px 24px rgba(255,95,126,0.55),inset 0 0 0 1px rgba(255,255,255,0.18);
}

/* Ring */
.ring{
  position:absolute;inset:-7px;
  width:calc(100% + 14px);height:calc(100% + 14px);
  pointer-events:none;transform:rotate(-90deg);
}
.rb{fill:none;stroke:rgba(255,255,255,0.07);stroke-width:3.5}
.rf{fill:none;stroke-width:3.5;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.mic.blue .rf{stroke:var(--blue)}
.mic.red  .rf{stroke:var(--red)}

/* Pulse recording */
@keyframes pulse{0%{transform:scale(1);opacity:.65}100%{transform:scale(1.8);opacity:0}}
.mic.recording::after{
  content:'';position:absolute;inset:-7px;border-radius:50%;
  border:2.5px solid currentColor;animation:pulse 1.1s ease-out infinite;
}
.mic.blue.recording{color:var(--blue)}
.mic.red.recording{color:var(--red)}

/* Pulse speaking */
@keyframes pulse-spk{0%{transform:scale(1);opacity:.45}100%{transform:scale(2);opacity:0}}
.mic.speaking-out::after{
  content:'';position:absolute;inset:-7px;border-radius:50%;
  border:2.5px solid var(--cyan);animation:pulse-spk 1s ease-out infinite;
}

/* DIVIDER */
.divider{
  flex-shrink:0;height:32px;
  display:flex;align-items:center;justify-content:center;gap:8px;
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
  background:rgba(255,255,255,0.015);
}
.divider svg{width:18px;height:18px;color:var(--muted)}
.divider span{font-size:10px;font-weight:700;letter-spacing:.1em;color:var(--muted)}

/* TOAST */
#toast{
  position:fixed;bottom:calc(18px + var(--safe-b));
  left:50%;transform:translateX(-50%) translateY(16px);
  background:rgba(20,20,40,0.97);border:1px solid var(--border-glow);
  border-radius:50px;padding:11px 22px;
  font-size:14px;font-weight:600;color:var(--text);
  z-index:999;opacity:0;transition:opacity .28s,transform .28s;
  pointer-events:none;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  white-space:nowrap;max-width:92vw;text-align:center;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="app">

  <div class="hdr">
    <h1>ğŸŒ MirrorTalk</h1>
    <p>Premi il microfono, parla â€” il telefono traduce e legge ad alta voce</p>
    <div class="badge">ğŸ¤– Web Speech Â· MyMemory Â· TTS nativo</div>
  </div>

  <div id="mirror">

    <!-- â•â•â• INTERLOCUTORE (ruotato 180Â°) â•â•â• -->
    <div class="half top" id="half-b">
      <div class="lbl">INTERLOCUTORE</div>
      <select class="lang-sel" id="lang-b" onchange="onLangChange('b')">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript ph" id="tr-b">Translation will appear hereâ€¦</div>
      <div class="st" id="st-b"></div>
      <div class="bwrap">
        <div class="tmr" id="tmr-b"></div>
        <button class="mic red" id="btn-b"
                ontouchstart="onTouchStart('b',event)"
                onclick="onTap('b')">
          <svg class="ring" viewBox="0 0 110 110">
            <circle class="rb" cx="55" cy="55" r="50"/>
            <circle class="rf" id="ring-b" cx="55" cy="55" r="50" stroke-dasharray="314" stroke-dashoffset="314"/>
          </svg>
          <div class="inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="lbl-b">Speak</span>
          </div>
        </button>
      </div>
    </div>

    <!-- DIVIDER -->
    <div class="divider">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
      <span>TRADUZIONE ISTANTANEA</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
    </div>

    <!-- â•â•â• IO / TU â•â•â• -->
    <div class="half" id="half-a">
      <div class="lbl">IO (TU)</div>
      <select class="lang-sel" id="lang-a" onchange="onLangChange('a')">
        <option value="it" selected>ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript ph" id="tr-a">La traduzione apparirÃ  quiâ€¦</div>
      <div class="st" id="st-a"></div>
      <div class="bwrap">
        <div class="tmr" id="tmr-a"></div>
        <button class="mic blue" id="btn-a"
                ontouchstart="onTouchStart('a',event)"
                onclick="onTap('a')">
          <svg class="ring" viewBox="0 0 110 110">
            <circle class="rb" cx="55" cy="55" r="50"/>
            <circle class="rf" id="ring-a" cx="55" cy="55" r="50" stroke-dasharray="314" stroke-dashoffset="314"/>
          </svg>
          <div class="inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="lbl-a">Parla</span>
          </div>
        </button>
      </div>
    </div>

  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
/*
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MIRRORTALK v4 â€” Fix iOS TTS
  
  PROBLEMA PRINCIPALE su iOS Safari:
  window.speechSynthesis.speak() funziona SOLO se invocata
  direttamente dentro un handler touch/click.
  Soluzione adottata:
    1. ontouchstart â†’ warm-up TTS + flag _ttsReady=true
    2. Al termine della traduzione, parla subito (non in async)
    Usiamo una coda pendente: se la traduzione arriva prima
    che l'utente abbia toccato di nuovo, la mettiamo in coda
    e la eseguiamo al prossimo tap (fallback).
    
  Stack (tutto gratuito):
    STT  â†’ Web Speech API  (Safari/Chrome)
    TRAD â†’ MyMemory API    (5000 req/giorno)
    TTS  â†’ SpeechSynthesis (nativa iOS/Android)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

const DEEPL_API_KEY = null; // opzionale: 'xxxx:fx'

const LC = {
  it:{ lbl:'Parla',    bcp:'it-IT', name:'Italiano',  dl:'IT' },
  en:{ lbl:'Speak',    bcp:'en-US', name:'English',   dl:'EN' },
  es:{ lbl:'Hablar',   bcp:'es-ES', name:'EspaÃ±ol',   dl:'ES' },
  fr:{ lbl:'Parler',   bcp:'fr-FR', name:'FranÃ§ais',  dl:'FR' },
  de:{ lbl:'Sprechen', bcp:'de-DE', name:'Deutsch',   dl:'DE' },
  pt:{ lbl:'Falar',    bcp:'pt-PT', name:'PortuguÃªs', dl:'PT' },
  ru:{ lbl:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ', bcp:'ru-RU', name:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',   dl:'RU' },
  zh:{ lbl:'è¯´è¯',     bcp:'zh-CN', name:'ä¸­æ–‡',       dl:'ZH' },
  ar:{ lbl:'ØªÙƒÙ„Ù…',    bcp:'ar-SA', name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',   dl:'AR' },
  bg:{ lbl:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸',   bcp:'bg-BG', name:'Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸', dl:'BG' },
  cs:{ lbl:'Mluvit',   bcp:'cs-CZ', name:'ÄŒeÅ¡tina',   dl:'CS' },
};

// â”€â”€ Stato globale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _ttsReady  = false;   // true dopo primo touchstart
let _pendingSpeak = null; // { text, lang, btn, ta } â€” da eseguire
let mRec=null, mSide=null, mTimer=null, mCnt=0, mBest='';
const SEC = 10;

// â”€â”€ Helpers UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gl(s){ return document.getElementById('lang-'+s).value; }
function onLangChange(s){
  const lc=LC[gl(s)]||LC.it;
  document.getElementById('lbl-'+s).textContent=lc.lbl;
}
let _tt;
function toast(m,d=3000){
  const el=document.getElementById('toast');
  el.textContent=m;el.classList.add('show');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),d);
}

// â”€â”€ iOS TTS warm-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Chiamato in ontouchstart â€” qui siamo in un gesto utente diretto
function warmUp(){
  if(_ttsReady) return;
  _ttsReady=true;
  // Sblocca AudioContext
  try{
    const ac=new(window.AudioContext||window.webkitAudioContext)();
    const b=ac.createBuffer(1,1,22050),s=ac.createBufferSource();
    s.buffer=b;s.connect(ac.destination);s.start(0);
    if(ac.state==='suspended')ac.resume();
  }catch(e){}
  // Speak silenzioso per sbloccare SpeechSynthesis su iOS
  if(window.speechSynthesis){
    const u=new SpeechSynthesisUtterance(' ');
    u.volume=0;u.rate=1;
    window.speechSynthesis.speak(u);
    // Precarica voci
    window.speechSynthesis.getVoices();
  }
}

// â”€â”€ TTS effettivo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSpeak(text, lang, onDone){
  if(!window.speechSynthesis||!text.trim()){onDone?.();return;}
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang=LC[lang]?.bcp||lang; u.rate=0.9; u.pitch=1;
  const voices=window.speechSynthesis.getVoices();
  const px=u.lang.slice(0,2);
  const voice=voices.find(v=>v.lang.startsWith(px)&&v.localService)
           ||voices.find(v=>v.lang.startsWith(px));
  if(voice)u.voice=voice;
  u.onend=()=>onDone?.();
  u.onerror=(e)=>{console.warn('TTS:',e.error);onDone?.();};
  window.speechSynthesis.speak(u);
  // Fix iOS pausa silenziosa
  setTimeout(()=>{if(window.speechSynthesis.paused)window.speechSynthesis.resume();},300);
}

// â”€â”€ Handler touch/click bottone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ontouchstart: warm up + avvia registrazione SUBITO
// (siamo nel gesto diretto â†’ TTS sarÃ  sbloccato)
function onTouchStart(side, ev){
  ev.preventDefault(); // evita doppio click
  warmUp();
  // Se c'Ã¨ una sintesi in coda, eseguila ORA che siamo nel gesto
  if(_pendingSpeak){
    const p=_pendingSpeak; _pendingSpeak=null;
    doSpeak(p.text, p.lang, ()=>{
      document.getElementById('btn-'+p.other).classList.remove('speaking-out');
      document.getElementById('tr-'+p.other).classList.remove('speaking');
    });
    return; // non avviare mic contemporaneamente
  }
  toggleMic(side);
}

// onclick: fallback per desktop o quando touchstart non c'Ã¨
function onTap(side){
  // Su mobile, onTouchStart ha giÃ  gestito â€” evitiamo doppio avvio
  // controlliamo se mSide Ã¨ giÃ  impostato correttamente
  // (questo handler arriva ~300ms dopo touchstart su iOS)
  // Non facciamo nulla: touchstart ha giÃ  gestito tutto
}

// â”€â”€ Mic toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMic(side){
  if(mSide===side){stopRec();return;}
  if(mSide){cancelRec();}
  startRec(side);
}

function startRec(side){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('âš ï¸ Usa Safari (iOS) o Chrome (Android)');return;}

  const from=gl(side), lc=LC[from]||LC.it;
  mSide=side; mBest='';

  const btn=document.getElementById('btn-'+side);
  const ta=document.getElementById('tr-'+side);
  const tmr=document.getElementById('tmr-'+side);
  const ring=document.getElementById('ring-'+side);

  btn.classList.add('recording');
  document.getElementById('lbl-'+side).textContent='Stop';
  ta.className='transcript listening';
  ta.textContent='ğŸ™ï¸ In ascoltoâ€¦';

  // Countdown ring
  mCnt=SEC;
  const C=314;
  ring.style.strokeDashoffset=C;
  mTimer=setInterval(()=>{
    mCnt--;
    tmr.textContent=mCnt+'s';
    ring.style.strokeDashoffset=C-((SEC-mCnt)/SEC)*C;
    if(mCnt<=0)stopRec();
  },1000);

  mRec=new SR();
  mRec.lang=lc.bcp;
  mRec.interimResults=true;
  mRec.continuous=true;

  mRec.onresult=(e)=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const t=e.results[i][0].transcript;
      if(e.results[i].isFinal)mBest+=t+' ';
      else interim=t;
    }
    ta.textContent=(mBest+interim).trim()||ta.textContent;
  };
  mRec.onerror=(e)=>{
    if(e.error==='no-speech'){stopRec();return;}
    if(e.error!=='aborted')toast('âŒ '+e.error);
    cancelRec();
  };
  mRec.onend=()=>{
    if(mSide===side&&mCnt>0){try{mRec.start();}catch(err){stopRec();}}
  };
  try{mRec.start();}
  catch(e){toast('âŒ Microfono non disponibile');cancelRec();}
}

async function stopRec(){
  if(!mSide)return;
  const side=mSide, from=gl(side), text=mBest.trim();
  _clearUI(side);

  const ta=document.getElementById('tr-'+side);
  ta.classList.remove('listening');

  if(!text){
    ta.className='transcript ph';
    ta.textContent='Nessun testo rilevato. Riprova.';
    return;
  }
  ta.textContent=text;

  const other=side==='a'?'b':'a';
  const toLang=gl(other);
  const otherTA=document.getElementById('tr-'+other);
  const stEl=document.getElementById('st-'+other);
  const otherBtn=document.getElementById('btn-'+other);

  otherTA.className='transcript';
  otherTA.textContent='â€¦';
  stEl.innerHTML='<div class="spin"></div> Traduzioneâ€¦';

  // Traduci
  const translated=await doTranslate(text,from,toLang);
  stEl.innerHTML='';

  const finalText=translated||text;
  otherTA.className='transcript speaking';
  otherTA.textContent=finalText;
  toast('ğŸ”Š '+(LC[toLang]?.name||toLang));

  const onDone=()=>{
    otherBtn.classList.remove('speaking-out');
    otherTA.classList.remove('speaking');
  };

  // *** SPEAK ***
  // Se TTS Ã¨ giÃ  sbloccato â†’ parla subito
  // Altrimenti metti in coda: il prossimo tap dell'utente la eseguirÃ 
  if(_ttsReady){
    otherBtn.classList.add('speaking-out');
    doSpeak(finalText, toLang, onDone);
  } else {
    // fallback: mostra tasto "tap per sentire"
    _pendingSpeak={text:finalText, lang:toLang, other};
    stEl.innerHTML='ğŸ‘† Tocca il microfono per sentire la traduzione';
    toast('ğŸ‘† Tocca il mic per ascoltare');
  }
}

function cancelRec(){_clearUI(mSide);}

function _clearUI(side){
  clearInterval(mTimer);mTimer=null;
  if(mRec){try{mRec.abort();}catch(e){}mRec=null;}
  if(!side)return;
  const lc=LC[gl(side)]||LC.it;
  document.getElementById('btn-'+side).classList.remove('recording','speaking-out');
  document.getElementById('lbl-'+side).textContent=lc.lbl;
  document.getElementById('tmr-'+side).textContent='';
  document.getElementById('ring-'+side).style.strokeDashoffset='314';
  document.getElementById('tr-'+side).classList.remove('listening');
  mSide=null;
}

// â”€â”€ Traduzione â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doTranslate(text,from,to){
  if(!text||from===to)return text;
  if(DEEPL_API_KEY){
    try{
      const r=await fetch('https://api-free.deepl.com/v2/translate',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({auth_key:DEEPL_API_KEY,text,
          source_lang:(LC[from]?.dl||from).toUpperCase(),
          target_lang:(LC[to]?.dl||to).toUpperCase()})
      });
      const d=await r.json();
      if(d.translations?.[0]?.text)return d.translations[0].text;
    }catch(e){console.warn('DeepL:',e);}
  }
  try{
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;
    const r=await fetch(url);
    const d=await r.json();
    if(d.responseStatus===200&&d.responseData?.translatedText){
      const t=d.responseData.translatedText;
      if(t&&t.toLowerCase()!==text.toLowerCase()&&!t.includes('MYMEMORY WARNING'))return t;
    }
  }catch(e){console.warn('MyMemory:',e);}
  return text;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  onLangChange('a'); onLangChange('b');
  if(window.speechSynthesis){
    window.speechSynthesis.getVoices();
    window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();
  }
});
</script>
</body>
</html>
