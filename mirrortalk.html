<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MirrorTalk">
<meta name="theme-color" content="#0a0a1a">
<title>MirrorTalk â€” Traduttore</title>
<style>
:root{
  --bg-dark:#0a0a1a;
  --bg-card:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.12);
  --border-glow:rgba(255,255,255,0.25);
  --text-primary:#f0f0ff;
  --text-secondary:rgba(240,240,255,0.55);
  --text-muted:rgba(240,240,255,0.3);
  --accent-blue:#4f9fff;
  --accent-red:#ff5f7e;
  --accent-cyan:#4ff0d0;
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --safe-top:env(safe-area-inset-top,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{
  width:100%;height:100%;overflow:hidden;
  touch-action:none;-webkit-text-size-adjust:none;
  background:var(--bg-dark);color:var(--text-primary);
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text',sans-serif;
  -webkit-font-smoothing:antialiased;
}
#app{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  padding-top:var(--safe-top);
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%,rgba(79,159,255,0.12) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%,rgba(79,240,208,0.10) 0%,transparent 60%),
    var(--bg-dark);
}

/* HEADER */
.app-header{
  flex-shrink:0;padding:12px 20px 8px;text-align:center;
  border-bottom:1px solid var(--border);
}
.app-header h1{
  font-size:19px;font-weight:800;letter-spacing:-.02em;
  background:linear-gradient(90deg,var(--text-primary),var(--accent-cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.app-header p{font-size:10px;color:var(--text-muted);margin-top:2px}
.ai-badge{
  display:inline-flex;align-items:center;gap:5px;
  margin-top:5px;padding:3px 12px;border-radius:50px;
  background:rgba(79,240,208,0.08);border:1px solid rgba(79,240,208,0.2);
  font-size:9px;font-weight:700;letter-spacing:.06em;color:var(--accent-cyan);
}

/* MIRROR */
#mirror{flex:1;display:flex;flex-direction:column;overflow:hidden}

.mirror-half{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:12px 16px;gap:9px;
  position:relative;overflow:hidden;
}
.mirror-half.top{
  transform:rotate(180deg);
  border-bottom:1px solid var(--border);
}
.side-label{
  position:absolute;top:6px;left:50%;transform:translateX(-50%);
  font-size:9px;font-weight:700;letter-spacing:.12em;
  color:var(--text-muted);text-transform:uppercase;
}
.mirror-half.top .side-label{top:auto;bottom:6px}

.lang-select{
  background:rgba(255,255,255,0.08);border:1px solid var(--border);
  border-radius:50px;color:var(--text-primary);
  font-size:14px;font-weight:600;padding:8px 18px;
  outline:none;-webkit-appearance:none;cursor:pointer;
  min-width:185px;text-align:center;transition:border-color .2s;
}
.lang-select option{background:#1a1a30}
.lang-select:focus{border-color:var(--border-glow)}

.transcript-area{
  width:100%;flex:1;
  display:flex;align-items:center;justify-content:center;
  text-align:center;padding:10px;
  font-size:16px;line-height:1.5;color:var(--text-primary);
  min-height:48px;max-height:110px;
  overflow-y:auto;border-radius:12px;
  border:1px solid transparent;
  transition:background .3s,border-color .3s;
}
.transcript-area.placeholder{color:var(--text-muted);font-style:italic;font-size:13px}
.transcript-area.listening{background:rgba(79,159,255,0.08);border-color:rgba(79,159,255,0.3)}
.transcript-area.speaking{background:rgba(79,240,208,0.08);border-color:rgba(79,240,208,0.3)}

.translate-status{
  font-size:12px;color:var(--accent-cyan);
  display:flex;align-items:center;gap:5px;min-height:16px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{
  width:11px;height:11px;
  border:2px solid rgba(79,240,208,0.3);
  border-top-color:var(--accent-cyan);
  border-radius:50%;animation:spin .8s linear infinite;
}

.speak-btn-wrap{
  position:relative;display:flex;flex-direction:column;
  align-items:center;gap:5px;flex-shrink:0;
}
.mic-timer{
  font-size:11px;font-weight:700;
  color:var(--text-muted);letter-spacing:.05em;min-height:14px;
}
.speak-btn{
  width:78px;height:78px;border-radius:50%;border:none;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  position:relative;transition:transform .15s;
  -webkit-tap-highlight-color:transparent;
}
.speak-btn:active{transform:scale(0.88)}
.speak-btn .btn-inner{
  width:100%;height:100%;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:3px;font-size:11px;font-weight:700;color:white;
}
.speak-btn .btn-icon{width:26px;height:26px}
.btn-a .btn-inner{
  background:linear-gradient(135deg,#4f9fff,#2d6bdd);
  box-shadow:0 4px 20px rgba(79,159,255,0.5),inset 0 0 0 1px rgba(255,255,255,0.15);
}
.btn-b .btn-inner{
  background:linear-gradient(135deg,#ff5f7e,#c03050);
  box-shadow:0 4px 20px rgba(255,95,126,0.5),inset 0 0 0 1px rgba(255,255,255,0.15);
}
.ring-svg{
  position:absolute;inset:-6px;
  width:calc(100% + 12px);height:calc(100% + 12px);
  pointer-events:none;transform:rotate(-90deg);
}
.ring-bg{fill:none;stroke:rgba(255,255,255,0.08);stroke-width:3}
.ring-fill{fill:none;stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.btn-a .ring-fill{stroke:#4f9fff}
.btn-b .ring-fill{stroke:#ff5f7e}
@keyframes pulse-ring{0%{transform:scale(1);opacity:.7}100%{transform:scale(1.7);opacity:0}}
.speak-btn.recording::after{
  content:'';position:absolute;inset:-6px;border-radius:50%;
  border:2px solid currentColor;animation:pulse-ring 1.2s ease-out infinite;
}
.btn-a.recording{color:var(--accent-blue)}
.btn-b.recording{color:var(--accent-red)}

/* Divider */
.divider{
  flex-shrink:0;height:30px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,0.02);
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
}
.divider svg{width:18px;height:18px;color:var(--text-muted)}

/* Toast */
#toast{
  position:fixed;bottom:calc(20px + var(--safe-bottom));
  left:50%;transform:translateX(-50%) translateY(20px);
  background:rgba(30,30,50,0.97);border:1px solid var(--border-glow);
  border-radius:50px;padding:10px 20px;
  font-size:13px;font-weight:600;color:var(--text-primary);
  z-index:300;opacity:0;transition:opacity .3s,transform .3s;
  pointer-events:none;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  white-space:nowrap;max-width:90vw;text-align:center;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="app">

  <div class="app-header">
    <h1>ğŸŒ MirrorTalk</h1>
    <p>Parla â€” il telefono traduce e legge ad alta voce per il tuo interlocutore</p>
    <div class="ai-badge">ğŸ¤– STT: Web Speech API &nbsp;Â·&nbsp; Traduzione: MyMemory &nbsp;Â·&nbsp; TTS: nativo</div>
  </div>

  <div id="mirror">

    <!-- METÃ€ SUPERIORE: interlocutore (schermo ruotato) -->
    <div class="mirror-half top" id="half-b">
      <div class="side-label">INTERLOCUTORE</div>
      <select class="lang-select" id="lang-b" onchange="onLangChange('b')">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript-area placeholder" id="transcript-b">La traduzione apparirÃ  quiâ€¦</div>
      <div class="translate-status" id="status-b"></div>
      <div class="speak-btn-wrap">
        <button class="speak-btn btn-b" id="btn-b" onclick="toggleMirrorMic('b')">
          <svg class="ring-svg" viewBox="0 0 96 96">
            <circle class="ring-bg" cx="48" cy="48" r="44"/>
            <circle class="ring-fill" id="ring-b" cx="48" cy="48" r="44" stroke-dasharray="276" stroke-dashoffset="276"/>
          </svg>
          <div class="btn-inner">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="btn-b-label">Speak</span>
          </div>
        </button>
        <div class="mic-timer" id="timer-b"></div>
      </div>
    </div>

    <div class="divider">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M7 16V4m0 0L3 8m4-4l4 4"/>
        <path d="M17 8v12m0 0l4-4m-4 4l-4-4"/>
      </svg>
    </div>

    <!-- METÃ€ INFERIORE: io / tu -->
    <div class="mirror-half" id="half-a">
      <div class="side-label">IO (TU)</div>
      <select class="lang-select" id="lang-a" onchange="onLangChange('a')">
        <option value="it" selected>ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript-area placeholder" id="transcript-a">La traduzione apparirÃ  quiâ€¦</div>
      <div class="translate-status" id="status-a"></div>
      <div class="speak-btn-wrap">
        <button class="speak-btn btn-a" id="btn-a" onclick="toggleMirrorMic('a')">
          <svg class="ring-svg" viewBox="0 0 96 96">
            <circle class="ring-bg" cx="48" cy="48" r="44"/>
            <circle class="ring-fill" id="ring-a" cx="48" cy="48" r="44" stroke-dasharray="276" stroke-dashoffset="276"/>
          </svg>
          <div class="btn-inner">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="btn-a-label">Parla</span>
          </div>
        </button>
        <div class="mic-timer" id="timer-a"></div>
      </div>
    </div>

  </div>
</div>

<div id="toast"></div>

<script>
'use strict';
/*
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MIRRORTALK â€” Traduttore Vocale Bidirezionale v3
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Come funziona:
  â€¢ Premi il microfono BLU  (IO)           â†’ parla nella tua lingua
    Il telefono ascolta, traduce e PARLA AD ALTA VOCE nella lingua dell'interlocutore
  â€¢ L'interlocutore preme il mic ROSSO     â†’ parla nella sua lingua
    Il telefono ascolta, traduce e PARLA AD ALTA VOCE nella tua lingua

  Tecnologia (100% gratuita, nessuna registrazione):
  â”Œâ”€ STT (riconoscimento voce) : Web Speech API (Chrome/Safari)
  â”œâ”€ Traduzione                : MyMemory API (gratuita, ~5000 req/giorno)
  â””â”€ TTS (sintesi vocale)      : SpeechSynthesis API (nativa del browser)

  Opzionale: inserisci la tua API key DeepL per traduzioni piÃ¹ accurate
  (specialmente utile per Bulgaro e Ceco):
*/
const DEEPL_API_KEY = null; // es: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:fx'

// â”€â”€ Configurazione lingue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LC = {
  it: { speak:'Parla',    stop:'Stop',   bcp:'it-IT', name:'Italiano',  dl:'IT' },
  en: { speak:'Speak',    stop:'Stop',   bcp:'en-US', name:'English',   dl:'EN' },
  es: { speak:'Hablar',   stop:'Stop',   bcp:'es-ES', name:'EspaÃ±ol',   dl:'ES' },
  fr: { speak:'Parler',   stop:'Stop',   bcp:'fr-FR', name:'FranÃ§ais',  dl:'FR' },
  de: { speak:'Sprechen', stop:'Stop',   bcp:'de-DE', name:'Deutsch',   dl:'DE' },
  zh: { speak:'è¯´è¯',     stop:'åœæ­¢',   bcp:'zh-CN', name:'ä¸­æ–‡',       dl:'ZH' },
  ar: { speak:'ØªÙƒÙ„Ù…',    stop:'Ø¥ÙŠÙ‚Ø§Ù', bcp:'ar-SA', name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',   dl:'AR' },
  pt: { speak:'Falar',    stop:'Parar',  bcp:'pt-PT', name:'PortuguÃªs', dl:'PT' },
  ru: { speak:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ', stop:'Ğ¡Ñ‚Ğ¾Ğ¿',   bcp:'ru-RU', name:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',   dl:'RU' },
  bg: { speak:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸',   stop:'Ğ¡Ñ‚Ğ¾Ğ¿',   bcp:'bg-BG', name:'Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸', dl:'BG' },
  cs: { speak:'Mluvit',   stop:'Stop',   bcp:'cs-CZ', name:'ÄŒeÅ¡tina',   dl:'CS' },
};

// â”€â”€ iOS Audio unlock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _unlocked = false;
function unlockAudio(){
  if(_unlocked) return; _unlocked = true;
  try{
    const c = new (window.AudioContext||window.webkitAudioContext)();
    const b = c.createBuffer(1,1,22050), s = c.createBufferSource();
    s.buffer = b; s.connect(c.destination); s.start(0);
    if(c.state==='suspended') c.resume();
  }catch(e){}
  if(window.speechSynthesis){
    const u = new SpeechSynthesisUtterance(''); u.volume=0;
    window.speechSynthesis.speak(u);
  }
}
document.addEventListener('touchstart', unlockAudio, {once:true});
document.addEventListener('click',      unlockAudio, {once:true});
document.addEventListener('touchmove',  e => e.preventDefault(), {passive:false});
document.addEventListener('gesturestart', e => e.preventDefault(), {passive:false});

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _toastT;
function showToast(m){
  const t = document.getElementById('toast');
  t.textContent = m; t.classList.add('show');
  clearTimeout(_toastT);
  _toastT = setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLang(s){ return document.getElementById('lang-'+s).value; }
function onLangChange(s){
  const l = LC[getLang(s)] || LC.it;
  const e = document.getElementById('btn-'+s+'-label');
  if(e) e.textContent = l.speak;
}

// â”€â”€ Traduzione â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function translateText(text, from, to){
  if(!text||!text.trim()||from===to) return text;

  // DeepL (opzionale, piÃ¹ accurato)
  if(DEEPL_API_KEY){
    try{
      const f = LC[from]?.dl||from.toUpperCase();
      const t_dl = LC[to]?.dl||to.toUpperCase();
      const r = await fetch('https://api-free.deepl.com/v2/translate',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({auth_key:DEEPL_API_KEY,text,source_lang:f,target_lang:t_dl})
      });
      const d = await r.json();
      if(d.translations?.[0]?.text) return d.translations[0].text;
    }catch(e){ console.warn('DeepL err',e); }
  }

  // MyMemory (gratuito, nessuna key)
  try{
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;
    const r = await fetch(url);
    const d = await r.json();
    if(d.responseStatus===200 && d.responseData?.translatedText){
      const t = d.responseData.translatedText;
      if(t.trim() && t.toLowerCase()!==text.toLowerCase() && !t.includes('MYMEMORY WARNING'))
        return t;
    }
  }catch(e){ console.warn('MyMemory err',e); }

  return text;
}

// â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speak(text, lang, onDone){
  if(!window.speechSynthesis||!text){ if(onDone) onDone(); return; }
  window.speechSynthesis.cancel();
  setTimeout(()=>{
    const u = new SpeechSynthesisUtterance(text);
    u.lang  = LC[lang]?.bcp || lang;
    u.rate  = 0.93; u.pitch = 1;
    const vs = window.speechSynthesis.getVoices();
    const px = u.lang.substring(0,2);
    const v  = vs.find(x=>x.lang.startsWith(px)&&x.localService)
            || vs.find(x=>x.lang.startsWith(px));
    if(v) u.voice = v;
    if(onDone) u.onend = onDone;
    window.speechSynthesis.speak(u);
  }, 120);
}
if(window.speechSynthesis){
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = ()=>window.speechSynthesis.getVoices();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MIRROR STT â€” ascolto + traduzione + voce
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MIC_SEC = 9;
let mRec=null, mSide=null, mTimer=null, mCnt=0, mBest='';

function toggleMirrorMic(side){
  if(mSide===side){ finishMirror(); return; }
  if(mSide){ cancelMirror(); }
  startMirror(side);
}

function startMirror(side){
  unlockAudio();
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ showToast('âš ï¸ Speech recognition non supportato (usa Chrome/Safari)'); return; }

  const from = getLang(side);
  const lc   = LC[from] || LC.it;
  mSide = side; mBest = '';

  const btn     = document.getElementById('btn-'+side);
  const lbl     = document.getElementById('btn-'+side+'-label');
  const ta      = document.getElementById('transcript-'+side);
  const timerEl = document.getElementById('timer-'+side);
  const ring    = document.getElementById('ring-'+side);

  btn.classList.add('recording');
  lbl.textContent = lc.stop;
  ta.classList.remove('placeholder','speaking');
  ta.classList.add('listening');
  ta.textContent = 'ğŸ™ï¸ In ascoltoâ€¦';

  // Countdown
  mCnt = MIC_SEC;
  const circ = 276;
  ring.style.strokeDashoffset = circ;
  mTimer = setInterval(()=>{
    mCnt--;
    timerEl.textContent = mCnt+'s';
    ring.style.strokeDashoffset = circ - ((MIC_SEC-mCnt)/MIC_SEC)*circ;
    if(mCnt<=0) finishMirror();
  },1000);

  // Riconoscimento vocale
  mRec = new SR();
  mRec.lang = lc.bcp;
  mRec.interimResults = true;
  mRec.continuous = true;

  mRec.onresult = (e)=>{
    let interim = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const t = e.results[i][0].transcript;
      if(e.results[i].isFinal) mBest += t+' ';
      else interim = t;
    }
    ta.textContent = (mBest+interim).trim() || ta.textContent;
  };
  mRec.onerror = (e)=>{
    if(e.error==='no-speech'){ finishMirror(); return; }
    if(e.error!=='aborted') showToast('âŒ '+e.error);
    cancelMirror();
  };
  // iOS riavvio automatico
  mRec.onend = ()=>{
    if(mSide===side && mCnt>0){ try{ mRec.start(); }catch(err){ finishMirror(); } }
  };
  try{ mRec.start(); }
  catch(e){ showToast('âŒ Microfono non disponibile'); cancelMirror(); }
}

async function finishMirror(){
  if(!mSide) return;
  const side = mSide;
  const from  = getLang(side);
  const text  = mBest.trim();
  _resetMirrorUI(side);

  const ta = document.getElementById('transcript-'+side);
  ta.classList.remove('listening');

  if(!text){
    ta.classList.add('placeholder');
    ta.textContent = 'Nessun testo rilevato. Riprova.';
    return;
  }
  ta.textContent = text;

  // Chi parla nel lato A â†’ la traduzione viene letta nel lato B, e viceversa
  const other    = side==='a' ? 'b' : 'a';
  const toLang   = getLang(other);
  const otherTA  = document.getElementById('transcript-'+other);
  const statusEl = document.getElementById('status-'+other);

  otherTA.classList.remove('placeholder','listening','speaking');
  statusEl.innerHTML = '<div class="spinner"></div> Traduzione in corsoâ€¦';

  const translated = await translateText(text, from, toLang);
  statusEl.innerHTML = '';

  const finalText = translated || text;
  otherTA.classList.add('speaking');
  otherTA.textContent = finalText;

  showToast('ğŸ”Š â†’ ' + (LC[toLang]?.name || toLang));

  // Parla ad alta voce nella lingua dell'altro
  speak(finalText, toLang, ()=>{
    otherTA.classList.remove('speaking');
  });
}

function cancelMirror(){
  _resetMirrorUI(mSide);
}

function _resetMirrorUI(side){
  clearInterval(mTimer); mTimer=null;
  if(mRec){ try{ mRec.abort(); }catch(e){} mRec=null; }
  if(side){
    const lc = LC[getLang(side)] || LC.it;
    const btn = document.getElementById('btn-'+side);
    btn.classList.remove('recording');
    document.getElementById('btn-'+side+'-label').textContent = lc.speak;
    document.getElementById('timer-'+side).textContent = '';
    document.getElementById('ring-'+side).style.strokeDashoffset = '276';
    document.getElementById('transcript-'+side).classList.remove('listening');
  }
  mSide = null;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  onLangChange('a');
  onLangChange('b');
});
</script>
</body>
</html>
