<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MirrorTalk">
<meta name="theme-color" content="#0a0a1a">
<title>MirrorTalk</title>
<style>
:root{
  --bg:#0a0a1a;
  --border:rgba(255,255,255,0.13);
  --border-glow:rgba(255,255,255,0.28);
  --text:#f0f0ff;
  --muted:rgba(240,240,255,0.32);
  --blue:#4f9fff;
  --red:#ff5f7e;
  --cyan:#4ff0d0;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{
  width:100%;height:100%;overflow:hidden;
  -webkit-text-size-adjust:none;
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;
  -webkit-font-smoothing:antialiased;
}
#app{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  padding-top:var(--safe-t);
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%,rgba(79,159,255,0.13) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%,rgba(79,240,208,0.11) 0%,transparent 60%),
    var(--bg);
}

/* HEADER */
.hdr{
  flex-shrink:0;padding:8px 16px 8px;text-align:center;
  border-bottom:1px solid var(--border);
}
.hdr h1{
  font-size:22px;font-weight:800;letter-spacing:-.02em;
  background:linear-gradient(90deg,#f0f0ff,var(--cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}

/* MIRROR */
#mirror{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}

.half{
  flex:1;min-height:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:14px 20px 10px;gap:11px;
  position:relative;
}
.half.top{transform:rotate(180deg);border-bottom:1px solid var(--border)}
.lbl{
  position:absolute;top:6px;left:50%;transform:translateX(-50%);
  font-size:10px;font-weight:700;letter-spacing:.13em;
  color:var(--muted);text-transform:uppercase;white-space:nowrap;
}
.half.top .lbl{top:auto;bottom:6px}

/* LANGUAGE SELECT */
.lang-sel{
  flex-shrink:0;
  background:rgba(255,255,255,0.09);border:1px solid var(--border);
  border-radius:50px;color:var(--text);
  font-size:16px;font-weight:600;padding:10px 22px;
  outline:none;-webkit-appearance:none;cursor:pointer;
  width:100%;max-width:280px;text-align:center;
}
.lang-sel option{background:#1a1a30}

/* TRANSCRIPT */
.transcript{
  width:100%;max-width:340px;flex:1;
  min-height:54px;max-height:115px;
  display:flex;align-items:center;justify-content:center;
  text-align:center;padding:12px 14px;
  font-size:18px;line-height:1.5;
  border-radius:14px;border:1px solid transparent;
  overflow-y:auto;transition:background .3s,border-color .3s;
}
.transcript.ph{color:var(--muted);font-style:italic;font-size:14px}
.transcript.listening{background:rgba(79,159,255,0.09);border-color:rgba(79,159,255,0.35)}
.transcript.speaking{background:rgba(79,240,208,0.09);border-color:rgba(79,240,208,0.35)}

/* STATUS */
.st{
  font-size:13px;color:var(--cyan);
  display:flex;align-items:center;gap:6px;min-height:18px;flex-shrink:0;
}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{
  width:13px;height:13px;flex-shrink:0;
  border:2px solid rgba(79,240,208,0.25);border-top-color:var(--cyan);
  border-radius:50%;animation:spin .75s linear infinite;
}

/* MIC BUTTON */
.bwrap{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:5px}
.tmr{font-size:12px;font-weight:700;color:var(--muted);min-height:15px}

.mic{
  width:96px;height:96px;border-radius:50%;border:none;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  position:relative;
  -webkit-tap-highlight-color:transparent;
  background:transparent;
  transition:transform .12s;
  /* permittiamo il touch passare */
  touch-action:manipulation;
}
.mic:active{transform:scale(0.85)}

.inner{
  position:absolute;inset:0;border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;font-size:12px;font-weight:700;color:#fff;pointer-events:none;
}
.inner svg{width:30px;height:30px}

.mic.blue .inner{
  background:linear-gradient(135deg,#4f9fff,#2060d0);
  box-shadow:0 6px 24px rgba(79,159,255,0.55),inset 0 0 0 1px rgba(255,255,255,0.18);
}
.mic.red .inner{
  background:linear-gradient(135deg,#ff5f7e,#b02848);
  box-shadow:0 6px 24px rgba(255,95,126,0.55),inset 0 0 0 1px rgba(255,255,255,0.18);
}

/* Ring */
.ring{
  position:absolute;inset:-7px;
  width:calc(100% + 14px);height:calc(100% + 14px);
  pointer-events:none;transform:rotate(-90deg);
}
.rb{fill:none;stroke:rgba(255,255,255,0.07);stroke-width:3.5}
.rf{fill:none;stroke-width:3.5;stroke-linecap:round;transition:stroke-dashoffset .1s linear}
.mic.blue .rf{stroke:var(--blue)}
.mic.red  .rf{stroke:var(--red)}

/* Pulse recording */
@keyframes pulse{0%{transform:scale(1);opacity:.65}100%{transform:scale(1.8);opacity:0}}
.mic.recording::after{
  content:'';position:absolute;inset:-7px;border-radius:50%;
  border:2.5px solid currentColor;animation:pulse 1.1s ease-out infinite;
}
.mic.blue.recording{color:var(--blue)}
.mic.red.recording{color:var(--red)}

/* Pulse speaking */
@keyframes pulse-spk{0%{transform:scale(1);opacity:.45}100%{transform:scale(2);opacity:0}}
.mic.speaking-out::after{
  content:'';position:absolute;inset:-7px;border-radius:50%;
  border:2.5px solid var(--cyan);animation:pulse-spk 1s ease-out infinite;
}

/* DIVIDER */
.divider{
  flex-shrink:0;height:28px;
  display:flex;align-items:center;justify-content:center;gap:16px;
  border-top:1px solid var(--border);border-bottom:1px solid var(--border);
  background:rgba(255,255,255,0.015);
}
.divider svg{width:18px;height:18px;color:var(--muted)}

/* TOAST */
#toast{
  position:fixed;bottom:calc(18px + var(--safe-b));
  left:50%;transform:translateX(-50%) translateY(16px);
  background:rgba(20,20,40,0.97);border:1px solid var(--border-glow);
  border-radius:50px;padding:11px 22px;
  font-size:14px;font-weight:600;color:var(--text);
  z-index:999;opacity:0;transition:opacity .28s,transform .28s;
  pointer-events:none;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  white-space:nowrap;max-width:92vw;text-align:center;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="app">

  <div class="hdr">
    <h1>ğŸŒ MirrorTalk</h1>
  </div>

  <div id="mirror">

    <!-- â•â•â• INTERLOCUTORE (ruotato 180Â°) â•â•â• -->
    <div class="half top" id="half-b">
      <div class="lbl">INTERLOCUTORE</div>
      <select class="lang-sel" id="lang-b" onchange="onLangChange('b')">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript ph" id="tr-b">Translation will appear hereâ€¦</div>
      <div class="st" id="st-b"></div>
      <div class="bwrap">
        <div class="tmr" id="tmr-b"></div>
        <button class="mic red" id="btn-b"
                ontouchstart="handleTap('b');event.preventDefault()"
                onclick="if(!('ontouchstart' in window))handleTap('b')">
          <svg class="ring" viewBox="0 0 110 110">
            <circle class="rb" cx="55" cy="55" r="50"/>
            <circle class="rf" id="ring-b" cx="55" cy="55" r="50" stroke-dasharray="314" stroke-dashoffset="314"/>
          </svg>
          <div class="inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="lbl-b">Speak</span>
          </div>
        </button>
      </div>
    </div>

    <!-- DIVIDER -->
    <div class="divider">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
    </div>

    <!-- â•â•â• IO / TU â•â•â• -->
    <div class="half" id="half-a">
      <div class="lbl">IO (TU)</div>
      <select class="lang-sel" id="lang-a" onchange="onLangChange('a')">
        <option value="it" selected>ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      </select>
      <div class="transcript ph" id="tr-a">La traduzione apparirÃ  quiâ€¦</div>
      <div class="st" id="st-a"></div>
      <div class="bwrap">
        <div class="tmr" id="tmr-a"></div>
        <button class="mic blue" id="btn-a"
                ontouchstart="handleTap('a');event.preventDefault()"
                onclick="if(!('ontouchstart' in window))handleTap('a')">
          <svg class="ring" viewBox="0 0 110 110">
            <circle class="rb" cx="55" cy="55" r="50"/>
            <circle class="rf" id="ring-a" cx="55" cy="55" r="50" stroke-dasharray="314" stroke-dashoffset="314"/>
          </svg>
          <div class="inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/>
            </svg>
            <span id="lbl-a">Parla</span>
          </div>
        </button>
      </div>
    </div>

  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
/*
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MIRRORTALK v5

  SOLUZIONE iOS TTS:
  iOS Safari permette speechSynthesis.speak() SOLO dentro
  un evento touch/click diretto. Strategia:
  
  1. Al PRIMO touchstart â†’ unlock AudioContext + speak vuoto (warm-up)
  2. La registrazione parte automaticamente e si ferma da sola
     quando smetti di parlare (no-speech / silence detection)
  3. Appena arriva la traduzione â†’ speak() chiamato direttamente
     (non in async, ma in una microtask che iOS ancora accetta
     se il warm-up Ã¨ stato fatto)
  4. Il tasto serve solo per AVVIARE â€” non serve Stop.
     Si ferma da solo dopo 2 secondi di silenzio.
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

const DEEPL_API_KEY = null;

const LC = {
  it:{ lbl:'Parla',    bcp:'it-IT', name:'Italiano',  dl:'IT' },
  en:{ lbl:'Speak',    bcp:'en-US', name:'English',   dl:'EN' },
  es:{ lbl:'Hablar',   bcp:'es-ES', name:'EspaÃ±ol',   dl:'ES' },
  fr:{ lbl:'Parler',   bcp:'fr-FR', name:'FranÃ§ais',  dl:'FR' },
  de:{ lbl:'Sprechen', bcp:'de-DE', name:'Deutsch',   dl:'DE' },
  pt:{ lbl:'Falar',    bcp:'pt-PT', name:'PortuguÃªs', dl:'PT' },
  ru:{ lbl:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ', bcp:'ru-RU', name:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',   dl:'RU' },
  zh:{ lbl:'è¯´è¯',     bcp:'zh-CN', name:'ä¸­æ–‡',       dl:'ZH' },
  ar:{ lbl:'ØªÙƒÙ„Ù…',    bcp:'ar-SA', name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',   dl:'AR' },
  bg:{ lbl:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸',   bcp:'bg-BG', name:'Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸', dl:'BG' },
  cs:{ lbl:'Mluvit',   bcp:'cs-CZ', name:'ÄŒeÅ¡tina',   dl:'CS' },
};

// â”€â”€ Stato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mRec=null, mSide=null, mTimer=null, mCnt=0, mBest='';
let _unlocked = false;
const SEC = 12;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gl(s){ return document.getElementById('lang-'+s).value; }
function onLangChange(s){
  document.getElementById('lbl-'+s).textContent = LC[gl(s)]?.lbl || 'Parla';
}
let _tt;
function toast(m, d=2800){
  const el=document.getElementById('toast');
  el.textContent=m; el.classList.add('show');
  clearTimeout(_tt); _tt=setTimeout(()=>el.classList.remove('show'),d);
}

// â”€â”€ UNLOCK AUDIO (iOS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Deve essere chiamato direttamente dentro touchstart/click
function unlockAudio(){
  if(_unlocked) return;
  _unlocked = true;
  // 1. Sblocca AudioContext
  try{
    const ac = new(window.AudioContext||window.webkitAudioContext)();
    const buf = ac.createBuffer(1,1,22050);
    const src = ac.createBufferSource();
    src.buffer=buf; src.connect(ac.destination); src.start(0);
    if(ac.state==='suspended') ac.resume();
  }catch(e){}
  // 2. Speak vuoto â€” sblocca SpeechSynthesis su iOS
  try{
    if(window.speechSynthesis){
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('');
      u.volume=0; u.lang='it-IT';
      window.speechSynthesis.speak(u);
    }
  }catch(e){}
}

// â”€â”€ SPEAK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speakText(text, lang){
  if(!window.speechSynthesis || !text) return;
  window.speechSynthesis.cancel();

  const go = () => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang  = LC[lang]?.bcp || 'en-US';
    u.rate  = 0.88;
    u.pitch = 1;
    // Scegli la voce migliore disponibile
    const vs  = window.speechSynthesis.getVoices();
    const px  = u.lang.slice(0,2);
    u.voice   = vs.find(v=>v.lang.startsWith(px)&&v.localService)
             || vs.find(v=>v.lang.startsWith(px))
             || null;
    window.speechSynthesis.speak(u);
    // Workaround: iOS a volte si mette in pausa da solo
    const fix = setInterval(()=>{
      if(!window.speechSynthesis.speaking){ clearInterval(fix); return; }
      if(window.speechSynthesis.paused) window.speechSynthesis.resume();
    }, 250);
    u.onend = u.onerror = ()=> clearInterval(fix);
  };

  // Piccolo delay per far sÃ¬ che iOS "accetti" la chiamata
  // (rimane abbastanza vicino al gesto utente)
  setTimeout(go, 80);
}

// â”€â”€ TRADUZIONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doTranslate(text, from, to){
  if(!text || from===to) return text;
  // DeepL opzionale
  if(DEEPL_API_KEY){
    try{
      const r = await fetch('https://api-free.deepl.com/v2/translate',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          auth_key: DEEPL_API_KEY, text,
          source_lang: (LC[from]?.dl||from).toUpperCase(),
          target_lang: (LC[to]?.dl||to).toUpperCase()
        })
      });
      const d = await r.json();
      if(d.translations?.[0]?.text) return d.translations[0].text;
    }catch(e){}
  }
  // MyMemory gratuito
  try{
    const r = await fetch(
      `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`
    );
    const d = await r.json();
    if(d.responseStatus===200 && d.responseData?.translatedText){
      const t = d.responseData.translatedText;
      if(t && !t.includes('MYMEMORY WARNING') && t.toLowerCase()!==text.toLowerCase())
        return t;
    }
  }catch(e){}
  return text;
}

// â”€â”€ MIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Il tap avvia la registrazione.
// Si ferma AUTOMATICAMENTE quando l'utente smette di parlare
// (onend senza no-speech = fine frase rilevata dal browser).
// Se si vuole fermare manualmente, si retappa.

function handleTap(side){
  // Questo viene chiamato da ontouchstart (mobile) o onclick (desktop)
  unlockAudio(); // PRIMA cosa: unlock dentro il gesto

  if(mSide === side){ // secondo tap â†’ stop manuale
    finishRec();
    return;
  }
  if(mSide){ cancelRec(); }
  startRec(side);
}

function startRec(side){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('âš ï¸ Usa Safari su iPhone o Chrome su Android'); return; }

  const from = gl(side);
  const lc   = LC[from] || LC.it;
  mSide=side; mBest='';

  const btn  = document.getElementById('btn-'+side);
  const ta   = document.getElementById('tr-'+side);
  const tmr  = document.getElementById('tmr-'+side);
  const ring = document.getElementById('ring-'+side);

  btn.classList.add('recording');
  document.getElementById('lbl-'+side).textContent = 'ğŸ›‘';
  ta.className='transcript listening';
  ta.textContent='ğŸ™ï¸ In ascoltoâ€¦';

  // Countdown ring (solo visivo, non forza lo stop)
  mCnt=SEC;
  const C=314;
  ring.style.strokeDashoffset=C;
  mTimer=setInterval(()=>{
    mCnt--;
    tmr.textContent=mCnt+'s';
    ring.style.strokeDashoffset = C-((SEC-mCnt)/SEC)*C;
    if(mCnt<=0) finishRec(); // safety timeout
  },1000);

  mRec=new SR();
  mRec.lang=lc.bcp;
  mRec.interimResults=true;
  mRec.continuous=false; // <-- FALSE: si ferma da solo quando smetti di parlare!

  mRec.onresult=(e)=>{
    mBest='';
    let interim='';
    for(let i=0;i<e.results.length;i++){
      if(e.results[i].isFinal) mBest+=e.results[i][0].transcript+' ';
      else interim+=e.results[i][0].transcript;
    }
    ta.textContent=(mBest+interim).trim();
  };

  mRec.onerror=(e)=>{
    if(e.error==='no-speech'){ finishRec(); return; }
    if(e.error==='aborted') return;
    toast('âŒ '+e.error);
    cancelRec();
  };

  // onend scatta automaticamente quando il browser rileva il silenzio
  mRec.onend=()=>{
    if(mSide===side) finishRec();
  };

  try{ mRec.start(); }
  catch(e){ toast('âŒ Microfono non disponibile'); cancelRec(); }
}

async function finishRec(){
  if(!mSide) return;
  const side=mSide, from=gl(side), text=mBest.trim();
  _clearUI(side);

  const ta=document.getElementById('tr-'+side);
  if(!text){
    ta.className='transcript ph';
    ta.textContent='Nessun testo. Riprova.';
    return;
  }
  ta.className='transcript'; ta.textContent=text;

  // Mostra spinner nell'altra metÃ 
  const other   = side==='a'?'b':'a';
  const toLang  = gl(other);
  const otherTA = document.getElementById('tr-'+other);
  const stEl    = document.getElementById('st-'+other);
  const otherBtn= document.getElementById('btn-'+other);

  otherTA.className='transcript'; otherTA.textContent='â€¦';
  stEl.innerHTML='<div class="spin"></div>';

  const translated = await doTranslate(text, from, toLang);
  stEl.innerHTML='';

  const finalText = translated||text;
  otherTA.className='transcript speaking';
  otherTA.textContent=finalText;

  // Animazione pulsante che "parla"
  otherBtn.classList.add('speaking-out');

  // *** PARLA *** â€” _unlocked Ã¨ giÃ  true grazie al tap iniziale
  speakText(finalText, toLang);

  // Rimuovi animazione dopo stima durata parlato
  const ms = Math.max(2000, finalText.length * 80);
  setTimeout(()=>{
    otherBtn.classList.remove('speaking-out');
    otherTA.classList.remove('speaking');
  }, ms);
}

function cancelRec(){ _clearUI(mSide); }

function _clearUI(side){
  clearInterval(mTimer); mTimer=null;
  if(mRec){ try{ mRec.abort(); }catch(e){} mRec=null; }
  if(!side) return;
  const lc=LC[gl(side)]||LC.it;
  const btn=document.getElementById('btn-'+side);
  btn.classList.remove('recording','speaking-out');
  document.getElementById('lbl-'+side).textContent=lc.lbl;
  document.getElementById('tmr-'+side).textContent='';
  document.getElementById('ring-'+side).style.strokeDashoffset='314';
  const ta=document.getElementById('tr-'+side);
  ta.classList.remove('listening');
  mSide=null;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  onLangChange('a'); onLangChange('b');
  if(window.speechSynthesis){
    window.speechSynthesis.getVoices();
    window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();
  }
});
</script>
</body>
</html>
