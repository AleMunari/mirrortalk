<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a1a">
<title>Traduttore</title>
<style>
:root {
  --bg: #0a0a1a;
  --border: rgba(255,255,255,0.12);
  --text: #f0f0ff;
  --muted: rgba(240,240,255,0.30);
  --blue: #4f9fff;
  --red: #ff5f7e;
  --cyan: #4ff0d0;
  --green: #4fdf7e;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  width: 100%; height: 100%; overflow: hidden;
  -webkit-text-size-adjust: none;
  background: var(--bg); color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  -webkit-font-smoothing: antialiased;
}
#app {
  position: fixed;
  top: env(safe-area-inset-top, 0px); left: 0; right: 0;
  bottom: env(safe-area-inset-bottom, 0px);
  display: flex; flex-direction: column;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(79,159,255,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 90%, rgba(79,240,208,0.09) 0%, transparent 60%),
    var(--bg);
}
.half {
  flex: 1; min-height: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: space-evenly;
  padding: 10px 20px;
}
.half.top { transform: rotate(180deg); border-bottom: 1px solid var(--border); }
.div {
  flex: 0 0 26px;
  display: flex; align-items: center; justify-content: center; gap: 18px;
  border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.012);
}
.div svg { width: 15px; height: 15px; color: var(--muted); }
.sel {
  width: 100%; max-width: 280px;
  background: rgba(255,255,255,0.08); border: 1px solid var(--border);
  border-radius: 50px; color: var(--text);
  font-size: 15px; font-weight: 600; padding: 9px 18px;
  text-align: center; outline: none; -webkit-appearance: none; cursor: pointer; flex-shrink: 0;
}
.sel option { background: #1a1a30; }
.txt {
  width: 100%; max-width: 320px; height: 80px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  text-align: center; font-size: 19px; line-height: 1.4;
  border-radius: 12px; border: 1px solid transparent;
  padding: 8px 12px; overflow-y: auto;
  transition: background .2s, border-color .2s;
}
.txt.ph  { color: var(--muted); font-style: italic; font-size: 13px; }
.txt.on  { background: rgba(79,223,126,0.09); border-color: rgba(79,223,126,0.4); }
.txt.say { background: rgba(79,240,208,0.09); border-color: rgba(79,240,208,0.4); }
.st { font-size: 12px; color: var(--cyan); display: flex; align-items: center; gap: 5px; height: 16px; flex-shrink: 0; }
@keyframes sp { to { transform: rotate(360deg); } }
.spin { width: 12px; height: 12px; flex-shrink: 0; border: 2px solid rgba(79,240,208,0.2); border-top-color: var(--cyan); border-radius: 50%; animation: sp .7s linear infinite; }

/* Contenitore dei due bottoni affiancati */
.btn-row {
  display: flex; gap: 24px; align-items: center; justify-content: center; flex-shrink: 0;
}

.mic {
  width: 84px; height: 84px; border-radius: 50%; border: none; background: transparent;
  cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation; flex-shrink: 0;
}
.mic:active { opacity: .8; }
.face {
  position: absolute; inset: 0; border-radius: 50%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; font-size: 11px; font-weight: 700; color: #fff; pointer-events: none;
}
.face svg { width: 26px; height: 26px; }

/* Verde: bottone parla */
.mic.grn .face { background: linear-gradient(135deg,#4fdf7e,#1e8c3c); box-shadow: 0 5px 22px rgba(79,223,126,0.5),inset 0 0 0 1px rgba(255,255,255,0.14); }
/* Rosso: bottone ascolta */
.mic.red .face { background: linear-gradient(135deg,#ff5f7e,#a01e3c); box-shadow: 0 5px 22px rgba(255,95,126,0.5),inset 0 0 0 1px rgba(255,255,255,0.14); }

/* Rosso disabilitato (nessun pending) */
.mic.red.disabled .face { background: linear-gradient(135deg,#553040,#2a0f1a); box-shadow: 0 2px 10px rgba(0,0,0,0.3),inset 0 0 0 1px rgba(255,255,255,0.07); opacity: 0.45; }

.rsvg { position: absolute; inset: -7px; width: calc(100% + 14px); height: calc(100% + 14px); pointer-events: none; transform: rotate(-90deg); }
.rb { fill: none; stroke: rgba(255,255,255,0.07); stroke-width: 3; }
.rf { fill: none; stroke-width: 3; stroke-linecap: round; }
.mic.grn .rf { stroke: var(--green); }
.mic.red .rf  { stroke: var(--red); }

@keyframes pr { 0%{transform:scale(1);opacity:.55} 100%{transform:scale(1.9);opacity:0} }
.mic.rec::after { content:''; position:absolute; inset:-7px; border-radius:50%; border:2.5px solid var(--green); animation:pr 1.1s ease-out infinite; }

@keyframes ps { 0%{transform:scale(1);opacity:.45} 100%{transform:scale(2.1);opacity:0} }
.mic.tts::after { content:''; position:absolute; inset:-7px; border-radius:50%; border:2.5px solid var(--cyan); animation:ps .9s ease-out infinite; }

#toast {
  position: fixed; bottom: calc(10px + env(safe-area-inset-bottom,0px));
  left: 50%; transform: translateX(-50%) translateY(12px);
  background: rgba(16,16,36,.97); border: 1px solid rgba(255,255,255,.22);
  border-radius: 50px; padding: 9px 20px; font-size: 13px; font-weight: 600; color: var(--text);
  z-index: 999; opacity: 0; transition: opacity .22s, transform .22s; pointer-events: none;
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  white-space: nowrap; max-width: 90vw; text-align: center;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div id="app">

  <!-- INTERLOCUTORE (ruotato 180Â°) -->
  <div class="half top">
    <select class="sel" id="lb" onchange="onLC('b')">
      <option value="en">ğŸ‡¬ğŸ‡§ English</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
      <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
      <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
      <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
      <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
    </select>
    <div class="txt ph" id="tb">â€¦</div>
    <div class="st" id="sb"></div>
    <div class="btn-row">
      <!-- Verde: parla/stop -->
      <button class="mic grn" id="bgb" onclick="tapRec('b')">
        <svg class="rsvg" viewBox="0 0 108 108"><circle class="rb" cx="54" cy="54" r="50"/><circle class="rf" id="rb" cx="54" cy="54" r="50" stroke-dasharray="314" stroke-dashoffset="314"/></svg>
        <div class="face">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
          <span id="nlb">Speak</span>
        </div>
      </button>
      <!-- Rosso: ascolta -->
      <button class="mic red disabled" id="bpb" onclick="tapPlay('b')">
        <div class="face">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
          <span id="llb">Ascolta</span>
        </div>
      </button>
    </div>
  </div>

  <div class="div">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
  </div>

  <!-- IO -->
  <div class="half">
    <select class="sel" id="la" onchange="onLC('a')">
      <option value="it" selected>ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="en">ğŸ‡¬ğŸ‡§ English</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
      <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
      <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
      <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
      <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
    </select>
    <div class="txt ph" id="ta">â€¦</div>
    <div class="st" id="sa"></div>
    <div class="btn-row">
      <!-- Verde: parla/stop -->
      <button class="mic grn" id="bga" onclick="tapRec('a')">
        <svg class="rsvg" viewBox="0 0 108 108"><circle class="rb" cx="54" cy="54" r="50"/><circle class="rf" id="ra" cx="54" cy="54" r="50" stroke-dasharray="314" stroke-dashoffset="314"/></svg>
        <div class="face">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg>
          <span id="nla">Parla</span>
        </div>
      </button>
      <!-- Rosso: ascolta -->
      <button class="mic red disabled" id="bpa" onclick="tapPlay('a')">
        <div class="face">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
          <span id="lla">Ascolta</span>
        </div>
      </button>
    </div>
  </div>

</div>
<div id="toast"></div>

<script>
'use strict';
/*
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Soluzione definitiva iOS Safari TTS (2024):

  PROBLEMA RADICALE: iOS Safari richiede che speak() sia
  chiamato NELLO STESSO STACK SINCRONO di un click/touch.
  Qualsiasi await, Promise.then, o setTimeout lo blocca.

  SOLUZIONE ADOTTATA:
  - Bottone VERDE: avvia/ferma il microfono (nessun countdown)
  - Bottone ROSSO: legge la traduzione (sincrono nel click)

  âš ï¸  REQUISITI iOS:
  - Togliere il silenziatore fisico (interruttore laterale)
  - Volume alzato
  - Safari (non Chrome su iOS, che non supporta STT)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

const BCP = {it:'it-IT',en:'en-US',es:'es-ES',fr:'fr-FR',de:'de-DE',pt:'pt-PT',ru:'ru-RU',zh:'zh-CN',ar:'ar-SA',bg:'bg-BG',cs:'cs-CZ'};
const LBL    = {it:'Parla',   en:'Speak',  es:'Hablar', fr:'Parler',  de:'Sprechen', pt:'Falar',   ru:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ', zh:'è¯´è¯',  ar:'ØªÙƒÙ„Ù…',  bg:'Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸', cs:'Mluvit'};
const LISTEN = {it:'Ascolta', en:'Listen', es:'Escuchar',fr:'Ã‰couter', de:'HÃ¶ren',    pt:'Ouvir',   ru:'Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ',  zh:'å¬',    ar:'Ø§Ø³ØªÙ…Ø¹', bg:'Ğ¡Ğ»ÑƒÑˆĞ°Ğ¹', cs:'Poslouchat'};

const $ = id => document.getElementById(id);
const gl = s => $(s==='a'?'la':'lb').value;

function onLC(s) {
  const ab = s==='a'?'a':'b';
  $('nl'+ab).textContent  = LBL[gl(s)]    || 'Speak';
  $('ll'+ab).textContent  = LISTEN[gl(s)] || 'Listen';
}

let toastT;
function toast(m, ms=3000) {
  const e=$('toast'); e.textContent=m; e.classList.add('show');
  clearTimeout(toastT); toastT=setTimeout(()=>e.classList.remove('show'),ms);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATO â€” una traduzione salvata per ogni lato
// pending[side] = { text, lang } â€” da leggere al click rosso
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pending = { a: null, b: null };

function setPlayReady(side, ready) {
  const btn = $('bp'+side);
  if (ready) {
    btn.classList.remove('disabled');
  } else {
    btn.classList.add('disabled');
    btn.classList.remove('tts');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEAK â€” chiamato SOLO in contesto sincrono di click
// Non usare mai dopo await o setTimeout!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function speakSync(text, langCode, btnId) {
  if (!window.speechSynthesis || !text) return;
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  // Su iOS NON impostare .voice (getVoices() ritorna [])
  // Lascia che iOS scelga la voce di sistema
  u.lang  = BCP[langCode] || 'en-US';
  u.rate  = 0.85;
  u.pitch = 1;
  u.volume = 1;

  const btn = $(btnId);
  if (btn) btn.classList.add('tts');
  const done = () => { if (btn) btn.classList.remove('tts'); };
  u.onend   = done;
  u.onerror = (e) => { console.warn('TTS error:', e.error); done(); };

  speechSynthesis.speak(u);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAP ROSSO â€” ascolta la traduzione
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tapPlay(side) {
  if (!pending[side]) return; // niente da ascoltare
  const p = pending[side];
  pending[side] = null;
  setPlayReady(side, false);
  speakSync(p.text, p.lang, 'bp'+side); // sincrono nel click âœ“
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADUZIONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doTranslate(text, from, to) {
  if (!text || from === to) return text;
  try {
    const r = await fetch(
      `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`
    );
    const d = await r.json();
    if (d.responseStatus === 200 && d.responseData?.translatedText) {
      const t = d.responseData.translatedText;
      if (t && !t.includes('MYMEMORY WARNING') && t.toLowerCase() !== text.toLowerCase())
        return t;
    }
  } catch(e) {}
  return text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MICROFONO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rec = null, rSide = null;
let rFinal = '', rInterim = '';

function tapRec(side) {
  if (rSide === side) {
    stopRec(side);
    return;
  }
  if (rSide) abortRec();
  startRec(side);
}

function startRec(side) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    toast('âš ï¸ Usa Safari su iPhone â€” Chrome su iOS non supporta il microfono');
    return;
  }

  const lang = gl(side);
  rSide = side; rFinal = ''; rInterim = '';

  const btn  = $('bg'+side);
  const ta   = $('t'+side);
  const lbl  = $('nl'+(side==='a'?'a':'b'));

  btn.classList.add('rec');
  lbl.textContent = 'â¹';
  ta.className = 'txt on';
  ta.textContent = 'ğŸ™ï¸ â€¦';

  rec = new SR();
  rec.lang = BCP[lang] || 'en-US';
  rec.interimResults = true;
  rec.continuous = true; // continuous=true per iOS (piÃ¹ stabile)
  rec.maxAlternatives = 1;

  rec.onresult = e => {
    rFinal = ''; rInterim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) rFinal += e.results[i][0].transcript + ' ';
      else rInterim += e.results[i][0].transcript;
    }
    ta.textContent = (rFinal + rInterim).trim() || 'ğŸ™ï¸ â€¦';
  };

  rec.onerror = e => {
    if (e.error === 'no-speech') { stopRec(side); return; }
    if (e.error !== 'aborted') toast('âŒ ' + e.error);
    abortRec();
  };

  rec.onend = () => {
    // Su iOS con continuous=true, onend scatta se il browser chiude
    // Riavvia se siamo ancora in registrazione
    if (rSide === side) {
      try { rec.start(); } catch(e) { stopRec(side); }
    }
  };

  try { rec.start(); }
  catch(e) { toast('âŒ Microfono non disponibile'); abortRec(); }
}

function stopRec(side) {
  const text = rFinal.trim() || rInterim.trim();
  abortRec();

  const ta = $('t'+side);
  if (!text) { ta.className = 'txt ph'; ta.textContent = 'â€¦'; return; }
  ta.className = 'txt';
  ta.textContent = text;

  // Calcola la lingua dell'altro lato
  const other  = side === 'a' ? 'b' : 'a';
  const toLang = gl(other);
  const oTA    = $('t'+other);
  const oSt    = $('s'+other);

  oTA.className = 'txt'; oTA.textContent = 'â€¦';
  oSt.innerHTML = '<div class="spin"></div>';

  // Traduci in background e salva il risultato in pending
  // La riproduzione avverrÃ  al click sul bottone rosso (sincrono)
  doTranslate(text, gl(side), toLang).then(out => {
    oSt.innerHTML = '';
    const final = out || text;
    oTA.className = 'txt say';
    oTA.textContent = final;

    // Salva per il click sul rosso
    pending[other] = { text: final, lang: toLang };
    setPlayReady(other, true);

    // Indica visivamente che c'Ã¨ audio pronto
    $('bp'+other).classList.add('tts');
    toast('ğŸ”Š Tocca il bottone rosso ' + (other==='a'?'ğŸ”µ':'ğŸ”´') + ' per ascoltare');
  });
}

function abortRec() {
  if (rec) { try { rec.abort(); } catch(e) {} rec = null; }
  if (!rSide) return;
  const side = rSide; rSide = null;
  const lbl = $('nl'+(side==='a'?'a':'b'));
  $('bg'+side).classList.remove('rec');
  lbl.textContent = LBL[gl(side)] || 'Speak';
  $('t'+side).classList.remove('on');
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  onLC('a'); onLC('b');
  toast('âš ï¸ Verifica: interruttore laterale NON in silenzioso', 4000);
});
</script>
</body>
</html>
